<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="theme-color" content="#1f2937">
    <title>Creature Bank Editor for Heroes 3: ERA</title>
    <link rel="manifest" href="#" id="manifestPlaceholder">
    <link rel="icon" href="./icon-64.png" type="image/png">
    <style>
        :root {
            --primary-bg: #1f2937;
            --secondary-bg: #111827;
            --tertiary-bg: #374151;
            --text-color: #f3f4f6;
            --input-bg: #111827;
            --border-color: #4b5563;
            --button-bg: #3b82f6;
            --button-hover: #2563eb;
            --indented-bg: #111827;
            --indented-border: #4b5563;
            --disabled-bg: #4b5563;
            --disabled-text: #9ca3af;
        }

        [data-theme="light"] {
            --primary-bg: #f3f4f6;
            --secondary-bg: #e5e7eb;
            --tertiary-bg: #d1d5db;
            --text-color: #1f2937;
            --input-bg: #ffffff;
            --border-color: #9ca3af;
            --button-bg: #3b82f6;
            --button-hover: #2563eb;
            --indented-bg: #e5e7eb;
            --indented-border: #9ca3af;
            --disabled-bg: #d1d5db;
            --disabled-text: #6b7280;
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: var(--primary-bg);
            color: var(--text-color);
            line-height: 1.6;
            transition: background-color 0.3s, color 0.3s;
            padding: 20px;
        }

        header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 30px;
        }

        .title-container h1 {
            font-size: 24px;
            margin-bottom: 10px;
        }

        .header-controls {
            display: flex;
            gap: 15px;
        }

        .browser-support {
            margin-top: 10px;
            font-size: 12px;
            padding: 8px;
            background-color: var(--indented-bg);
            border: 1px solid var(--indented-border);
            border-radius: 4px;
            max-width: 300px;
        }

        button {
            background-color: var(--button-bg);
            color: white;
            border: none;
            padding: 8px 12px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            transition: background-color 0.2s;
        }

        button:hover {
            background-color: var(--button-hover);
        }

        .theme-toggle, .lang-selector {
            position: relative;
        }

        .dropdown {
            position: absolute;
            top: 100%;
            right: 0;
            background-color: var(--secondary-bg);
            border: 1px solid var(--border-color);
            border-radius: 4px;
            padding: 8px 0;
            z-index: 100;
            min-width: 150px;
            display: none;
        }

        .dropdown.show {
            display: block;
        }

        .dropdown button {
            display: block;
            width: 100%;
            text-align: left;
            background: none;
            color: var(--text-color);
            padding: 8px 16px;
        }

        .dropdown button:hover {
            background-color: var(--tertiary-bg);
        }

        .editor-container {
            background-color: var(--secondary-bg);
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        .field-group {
            width: 100%;
            margin-bottom: 15px;
            padding: 10px;
            border-radius: 6px;
            background-color: var(--indented-bg);
            border: 1px solid var(--indented-border);
        }

        .field-row {
            display: flex;
            margin-bottom: 10px;
            align-items: center;
        }

        .field-label {
            flex: 0 0 200px;
            display: flex;
            align-items: center;
        }

        .help-icon {
            margin-left: 8px;
            cursor: pointer;
            font-size: 16px;
            color: var(--button-bg);
            position: relative;
        }

        .tooltip {
            position: absolute;
            top: -10px;
            left: 25px;
            background-color: var(--tertiary-bg);
            padding: 10px;
            border-radius: 4px;
            font-size: 14px;
            width: 250px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
            z-index: 100;
            display: none;
        }

        .help-icon:hover .tooltip {
            display: block;
        }

        .field-input {
            flex: 1;
        }

        input[type="text"],
        input[type="number"],
        select {
            width: 100%;
            padding: 8px 12px;
            border-radius: 4px;
            border: 1px solid var(--border-color);
            background-color: var(--input-bg);
            color: var(--text-color);
        }

        input[type="checkbox"] {
            margin-right: 10px;
        }

        .disabled {
            opacity: 0.6;
            pointer-events: none;
        }

        .array-field {
            margin-left: 20px;
            margin-top: 10px;
        }

        .array-item {
            display: flex;
            align-items: center;
            margin-bottom: 8px;
        }

        .add-item {
            margin-top: 10px;
        }

        .bottom-controls {
            margin-top: 20px;
        }

        .save-button {
            padding: 10px 20px;
            font-size: 16px;
            margin-bottom: 20px;
        }

        .save-button:disabled {
            background-color: var(--disabled-bg);
            color: var (--disabled-text);
            cursor: not-allowed;
        }

        .json-preview-toggle {
            margin-bottom: 10px;
        }

        .json-preview {
            background-color: var(--indented-bg);
            padding: 15px;
            border-radius: 6px;
            display: none;
            white-space: pre-wrap;
            font-family: monospace;
            max-height: 400px;
            overflow-y: auto;
            border: 1px solid var(--indented-border);
        }

        .json-preview.show {
            display: block;
        }

        .install-pwa {
            display: none;
        }

        @media (max-width: 768px) {
            header {
                flex-direction: column;
            }
            
            .header-controls {
                margin-top: 15px;
            }
            
            .field-row {
                flex-direction: column;
                align-items: flex-start;
            }
            
            .field-label {
                margin-bottom: 5px;
            }
        }
    </style>
</head>
<body>
    <header>
        <div class="title-container">
            <h1 id="app-title">Creature Bank Editor for Heroes 3: ERA</h1>
        </div>
        <div>
            <div class="header-controls">
                <button id="install-pwa" class="install-pwa">Install PWA App</button>
                <div class="theme-toggle">
                    <button id="theme-toggle-btn">Dark Theme</button>
                </div>
                <div class="lang-selector">
                    <button id="lang-selector-btn">English</button>
                    <div class="dropdown" id="lang-dropdown">
                        <button data-lang="en">English</button>
                        <button data-lang="ru">Русский</button>
                    </div>
                </div>
            </div>
            <div class="browser-support" id="browser-support">
                Primarily supported in Chromium-based browsers (Chrome, Edge, Opera, etc.). Firefox, Safari, and others work with limitations.
            </div>
        </div>
    </header>

    <div class="editor-container">
        <!-- Object Subtype -->
        <div class="field-group">
            <h3 id="object-subtype-title">Object subtype</h3>
            
            <div class="field-row">
                <div class="field-label">
                    subtype <span class="help-icon">?
                        <div class="tooltip" id="help-subtype">The numeric subtype key for the object.</div>
                    </span>
                </div>
                <div class="field-input">
                    <input type="number" id="object-subtype" min="0" value="13">
                </div>
            </div>
        </div>

        <!-- Required Fields -->
        <div class="field-group">
            <h3 id="required-fields-title">Required Fields</h3>
            
            <div class="field-row">
                <div class="field-label">
                    value <span class="help-icon">?
                        <div class="tooltip" id="help-value">Loading help text...</div>
                    </span>
                </div>
                <div class="field-input">
                    <input type="number" id="value" min="0">
                </div>
            </div>
            
            <div class="field-row">
                <div class="field-label">
                    density <span class="help-icon">?
                        <div class="tooltip" id="help-density">Loading help text...</div>
                    </span>
                </div>
                <div class="field-input">
                    <input type="number" id="density" min="0">
                </div>
            </div>
            
            <div class="field-row">
                <div class="field-label">
                    properties <span class="help-icon">?
                        <div class="tooltip" id="help-properties">Loading help text...</div>
                    </span>
                </div>
                <div class="field-input">
                    <input type="text" id="properties">
                </div>
            </div>
        </div>
        
        <!-- Optional Fields -->
        <div class="field-group">
            <h3 id="optional-fields-title">Optional Fields</h3>
            
            <div class="field-row">
                <div class="field-label">
                    <input type="checkbox" id="enabled-checkbox">
                    enabled <span class="help-icon">?
                        <div class="tooltip" id="help-enabled">Loading help text...</div>
                    </span>
                </div>
                <div class="field-input disabled" id="enabled-container">
                    <select id="enabled">
                        <option value="true">true</option>
                        <option value="false">false</option>
                    </select>
                </div>
            </div>
            
            <div class="field-row">
                <div class="field-label">
                    <input type="checkbox" id="name-checkbox">
                    name <span class="help-icon">?
                        <div class="tooltip" id="help-name">Loading help text...</div>
                    </span>
                </div>
                <div class="field-input disabled" id="name-container">
                    <input type="text" id="name">
                </div>
            </div>
            
            <div class="field-row">
                <div class="field-label">
                    <input type="checkbox" id="sound-checkbox">
                    sound <span class="help-icon">?
                        <div class="tooltip" id="help-sound">Loading help text...</div>
                    </span>
                </div>
                <div class="field-input disabled" id="sound-container">
                    <div class="field-row">
                        <div class="field-label">enter</div>
                        <div class="field-input">
                            <input type="text" id="sound-enter" placeholder="filename.wav">
                        </div>
                    </div>
                    <div class="field-row">
                        <div class="field-label">loop</div>
                        <div class="field-input">
                            <input type="text" id="sound-loop" placeholder="filename.wav">
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="field-row">
                <div class="field-label">
                    <input type="checkbox" id="states-checkbox">
                    states <span class="help-icon">?
                        <div class="tooltip" id="help-states">Loading help text...</div>
                    </span>
                </div>
                <div class="field-input disabled" id="states-container">
                    <div id="states-items">
                        <!-- State item template -->
                        <div class="state-item">
                            <div class="field-group">
                                <h4>State #1</h4>
                                
                                <!-- Optional fields within state -->
                                <div class="field-row">
                                    <div class="field-label">
                                        <input type="checkbox" id="state-morale-checkbox-0">
                                        morale <span class="help-icon">?
                                            <div class="tooltip" id="help-state-morale-0">Loading help text...</div>
                                        </span>
                                    </div>
                                    <div class="field-input disabled" id="state-morale-container-0">
                                        <input type="number" id="state-morale-0" min="-3" max="3">
                                    </div>
                                </div>

                                <div class="field-row">
                                    <div class="field-label">
                                        <input type="checkbox" id="state-luck-checkbox-0">
                                        luck <span class="help-icon">?
                                            <div class="tooltip" id="help-state-luck-0">Loading help text...</div>
                                        </span>
                                    </div>
                                    <div class="field-input disabled" id="state-luck-container-0">
                                        <input type="number" id="state-luck-0" min="-3" max="3">
                                    </div>
                                </div>

                                <div class="field-row">
                                    <div class="field-label">
                                        <input type="checkbox" id="state-spells-checkbox-0">
                                        spells
                                    </div>
                                    <div class="field-input disabled" id="state-spells-container-0">
                                        <div id="state-spells-items-0">
                                            <div class="array-item">
                                                <div class="field-group">
                                                    <div class="field-row">
                                                        <div class="field-label">
                                                            <input type="checkbox" id="state-spell-id-checkbox-0-0">
                                                            id
                                                        </div>
                                                        <div class="field-input disabled" id="state-spell-id-container-0-0">
                                                            <input type="number" id="state-spell-id-0-0" min="0">
                                                        </div>
                                                    </div>
                                                    
                                                    <div class="field-row">
                                                        <div class="field-label">
                                                            <input type="checkbox" id="state-spell-bits-checkbox-0-0">
                                                            bits
                                                        </div>
                                                        <div class="field-input disabled" id="state-spell-bits-container-0-0">
                                                            <div class="field-group">
                                                                <div class="field-row">
                                                                    <div class="field-label">flags</div>
                                                                    <div class="field-input">
                                                                        <input type="number" id="state-spell-bits-flags-0-0" min="0">
                                                                    </div>
                                                                </div>
                                                                <div class="field-row">
                                                                    <div class="field-label">levels</div>
                                                                    <div class="field-input">
                                                                        <input type="number" id="state-spell-bits-levels-0-0" min="0">
                                                                    </div>
                                                                </div>
                                                                <div class="field-row">
                                                                    <div class="field-label">schools</div>
                                                                    <div class="field-input">
                                                                        <input type="number" id="state-spell-bits-schools-0-0" min="0">
                                                                    </div>
                                                                </div>
                                                            </div>
                                                        </div>
                                                    </div>
                                                </div>
                                                <button class="remove-spell">-</button>
                                            </div>
                                        </div>
                                        <button class="add-spell" data-state-index="0">+</button>
                                    </div>
                                </div>

                                <div class="field-row">
                                    <div class="field-label">
                                        <input type="checkbox" id="state-spellPoints-checkbox-0">
                                        spellPoints
                                    </div>
                                    <div class="field-input disabled" id="state-spellPoints-container-0">
                                        <input type="number" id="state-spellPoints-0" min="0">
                                    </div>
                                </div>

                                <div class="field-row">
                                    <div class="field-label">
                                        <input type="checkbox" id="state-experience-checkbox-0">
                                        experience
                                    </div>
                                    <div class="field-input disabled" id="state-experience-container-0">
                                        <input type="number" id="state-experience-0" min="0">
                                    </div>
                                </div>

                                <div class="field-row">
                                    <div class="field-label">
                                        <input type="checkbox" id="state-skills-checkbox-0">
                                        skills
                                    </div>
                                    <div class="field-input disabled" id="state-skills-container-0">
                                        <div class="field-row">
                                            <div class="field-label">primary (comma-separated)</div>
                                            <div class="field-input">
                                                <input type="text" id="state-skills-primary-0" placeholder="0,1,2,3">
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <div class="field-row">
                                    <div class="field-label">
                                        <input type="checkbox" id="state-guardians-checkbox-0">
                                        guardians
                                    </div>
                                    <div class="field-input disabled" id="state-guardians-container-0">
                                        <div class="field-row">
                                            <div class="field-label">count (comma-separated)</div>
                                            <div class="field-input">
                                                <input type="text" id="state-guardians-count-0" placeholder="15,15,15,0,0,0,0">
                                            </div>
                                        </div>
                                        <div class="field-row">
                                            <div class="field-label">type (comma-separated)</div>
                                            <div class="field-input">
                                                <input type="text" id="state-guardians-type-0" placeholder="59,59,59,-1,-1,-1,-1">
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <div class="field-row">
                                    <div class="field-label">
                                        <input type="checkbox" id="state-resources-checkbox-0">
                                        resources
                                    </div>
                                    <div class="field-input disabled" id="state-resources-container-0">
                                        <input type="text" id="state-resources-0" placeholder="0,0,0,0,0,0,2500,12">
                                    </div>
                                </div>

                                <div class="field-row">
                                    <div class="field-label">
                                        <input type="checkbox" id="state-chance-checkbox-0">
                                        chance
                                    </div>
                                    <div class="field-input disabled" id="state-chance-container-0">
                                        <input type="number" id="state-chance-0" min="0" max="100">
                                    </div>
                                </div>
                            </div>
                            <button class="remove-state">Remove State</button>
                        </div>
                    </div>
                    <button class="add-item" id="add-state">Add State</button>
                </div>
            </div>
            
            <!-- Remove the spells field that was here as it's now inside the states structure -->
        </div>
    </div>

    <div class="bottom-controls">
        <button class="save-button" id="save-file" disabled>Save File</button>
        
        <button class="json-preview-toggle" id="toggle-json">Show JSON Code</button>
        <div class="json-preview" id="json-preview"></div>
    </div>

    <script>
        // Localization setup
        let translations = {};
        let currentLang = 'en';
        let isDarkTheme = true;

        // Function to load language file
        async function loadLanguage(lang) {
            try {
                const response = await fetch(`./lang/${lang}.json`);
                if (!response.ok) {
                    throw new Error(`Failed to load language file: ${response.status}`);
                }
                translations = await response.json();
                currentLang = lang;
                updateUILanguage();
            } catch (error) {
                console.error('Error loading language file:', error);
                // Fallback to English if there's an error
                if (lang !== 'en') {
                    loadLanguage('en');
                }
            }
        }

        // Function to update the UI language
        function updateUILanguage() {
            document.getElementById('app-title').textContent = translations.appTitle;
            document.getElementById('install-pwa').textContent = translations.installPwa;
            document.getElementById('theme-toggle-btn').textContent = isDarkTheme ? 
                translations.darkTheme : translations.lightTheme;
            document.getElementById('lang-selector-btn').textContent = translations.currentLanguage;
            document.getElementById('browser-support').textContent = translations.browserSupport;
            document.getElementById('required-fields-title').textContent = translations.requiredFields;
            document.getElementById('optional-fields-title').textContent = translations.optionalFields;
            document.getElementById('save-file').textContent = translations.saveFile;
            
            const jsonToggleBtn = document.getElementById('toggle-json');
            const isShowingJson = document.getElementById('json-preview').classList.contains('show');
            jsonToggleBtn.textContent = isShowingJson ? 
                translations.hideJsonCode : translations.showJsonCode;
            
            // Update field labels with translations
            document.querySelectorAll('.field-label').forEach(label => {
                // Skip labels that contain checkboxes
                if (label.querySelector('input[type="checkbox"]')) return;
                
                // Get the text node (first text part of the label)
                const textNode = Array.from(label.childNodes).find(node => 
                    node.nodeType === Node.TEXT_NODE && node.textContent.trim());
                
                if (textNode) {
                    const key = textNode.textContent.trim();
                    if (translations.fieldLabels && translations.fieldLabels[key]) {
                        textNode.textContent = translations.fieldLabels[key] + ' ';
                    }
                }
            });
            
            // Update checkbox labels
            document.querySelectorAll('.field-label input[type="checkbox"]').forEach(checkbox => {
                const label = checkbox.parentElement;
                // Get the text node after the checkbox
                const textNode = Array.from(label.childNodes).find(node => 
                    node.nodeType === Node.TEXT_NODE && node.textContent.trim());
                
                if (textNode) {
                    const key = textNode.textContent.trim();
                    if (translations.fieldLabels && translations.fieldLabels[key]) {
                        textNode.textContent = ' ' + translations.fieldLabels[key] + ' ';
                    }
                }
            });
            
            // Update basic help texts
            document.getElementById('help-value').textContent = translations.helpTexts?.value || translations.helpValue;
            document.getElementById('help-density').textContent = translations.helpTexts?.density || translations.helpDensity;
            document.getElementById('help-properties').textContent = translations.helpTexts?.properties || translations.helpProperties;
            document.getElementById('help-enabled').textContent = translations.helpTexts?.enabled || translations.helpEnabled;
            document.getElementById('help-name').textContent = translations.helpTexts?.name || translations.helpName;
            document.getElementById('help-sound').textContent = translations.helpTexts?.sound || translations.helpSound;
            document.getElementById('help-states').textContent = translations.helpTexts?.states || translations.helpStates;
            document.getElementById('object-subtype-title').textContent = translations.objectSubtype;
            document.getElementById('help-subtype').textContent = translations.helpTexts?.subtype || translations.helpSubtype;
            
            // Add detailed help texts for state fields
            if (translations.helpTexts) {
                // Update morale help
                const moraleHelp = document.querySelectorAll('[id^="help-state-morale-"]');
                moraleHelp.forEach(el => {
                    if (el) el.textContent = translations.helpTexts.statesMorale;
                });
                
                // Update luck help
                const luckHelp = document.querySelectorAll('[id^="help-state-luck-"]');
                luckHelp.forEach(el => {
                    if (el) el.textContent = translations.helpTexts.statesLuck;
                });
                
                // Update spells help
                const spellsHelp = document.querySelectorAll('[id^="help-state-spells-"]');
                spellsHelp.forEach(el => {
                    if (el) el.textContent = translations.helpTexts.spells;
                });
                
                // Update spell ID help
                const spellIdHelp = document.querySelectorAll('[id^="help-state-spell-id-"]');
                spellIdHelp.forEach(el => {
                    if (el) el.textContent = translations.helpTexts.spellsId;
                });
                
                // Update spell bits help
                const spellBitsHelp = document.querySelectorAll('[id^="help-state-spell-bits-"]');
                spellBitsHelp.forEach(el => {
                    if (el) el.textContent = translations.helpTexts.spellsBits;
                });
                
                // Update spell bits flags help
                const spellBitsFlagsHelp = document.querySelectorAll('.field-label:contains("flags")');
                spellBitsFlagsHelp.forEach(el => {
                    // Add tooltip structure if not present
                    if (!el.querySelector('.help-icon')) {
                        el.innerHTML += ` <span class="help-icon">?<div class="tooltip">${translations.helpTexts.bitsFlags}</div></span>`;
                    } else if (el.querySelector('.tooltip')) {
                        el.querySelector('.tooltip').textContent = translations.helpTexts.bitsFlags;
                    }
                });
                
                // Update spell bits levels help
                const spellBitsLevelsHelp = document.querySelectorAll('.field-label:contains("levels")');
                spellBitsLevelsHelp.forEach(el => {
                    // Add tooltip structure if not present
                    if (!el.querySelector('.help-icon')) {
                        el.innerHTML += ` <span class="help-icon">?<div class="tooltip">${translations.helpTexts.bitsLevels}</div></span>`;
                    } else if (el.querySelector('.tooltip')) {
                        el.querySelector('.tooltip').textContent = translations.helpTexts.bitsLevels;
                    }
                });
                
                // Update spell bits schools help
                const spellBitsSchoolsHelp = document.querySelectorAll('.field-label:contains("schools")');
                spellBitsSchoolsHelp.forEach(el => {
                    // Add tooltip structure if not present
                    if (!el.querySelector('.help-icon')) {
                        el.innerHTML += ` <span class="help-icon">?<div class="tooltip">${translations.helpTexts.bitsSchools}</div></span>`;
                    } else if (el.querySelector('.tooltip')) {
                        el.querySelector('.tooltip').textContent = translations.helpTexts.bitsSchools;
                    }
                });
                
                // Update spell points help
                const spellPointsHelp = document.querySelectorAll('.field-label:contains("spellPoints")');
                spellPointsHelp.forEach(el => {
                    // Add tooltip structure if not present
                    if (!el.querySelector('.help-icon')) {
                        el.innerHTML += ` <span class="help-icon">?<div class="tooltip">${translations.helpTexts.spellPoints}</div></span>`;
                    } else if (el.querySelector('.tooltip')) {
                        el.querySelector('.tooltip').textContent = translations.helpTexts.spellPoints;
                    }
                });
                
                // Update experience help
                const experienceHelp = document.querySelectorAll('.field-label:contains("experience")');
                experienceHelp.forEach(el => {
                    // Add tooltip structure if not present
                    if (!el.querySelector('.help-icon')) {
                        el.innerHTML += ` <span class="help-icon">?<div class="tooltip">${translations.helpTexts.experience}</div></span>`;
                    } else if (el.querySelector('.tooltip')) {
                        el.querySelector('.tooltip').textContent = translations.helpTexts.experience;
                    }
                });
                
                // Update skills help
                const skillsHelp = document.querySelectorAll('.field-label:contains("skills")');
                skillsHelp.forEach(el => {
                    // Add tooltip structure if not present
                    if (!el.querySelector('.help-icon') && !el.querySelector('input[type="checkbox"]')) {
                        el.innerHTML += ` <span class="help-icon">?<div class="tooltip">${translations.helpTexts.skills}</div></span>`;
                    } else if (el.querySelector('.tooltip')) {
                        el.querySelector('.tooltip').textContent = translations.helpTexts.skills;
                    }
                });
                
                // Update skills primary help
                const skillsPrimaryHelp = document.querySelectorAll('.field-label:contains("primary")');
                skillsPrimaryHelp.forEach(el => {
                    // Add tooltip structure if not present
                    if (!el.querySelector('.help-icon')) {
                        el.innerHTML += ` <span class="help-icon">?<div class="tooltip">${translations.helpTexts.skillsPrimary}</div></span>`;
                    } else if (el.querySelector('.tooltip')) {
                        el.querySelector('.tooltip').textContent = translations.helpTexts.skillsPrimary;
                    }
                });
                
                // Update guardians help
                const guardiansHelp = document.querySelectorAll('.field-label:contains("guardians")');
                guardiansHelp.forEach(el => {
                    // Skip checkbox labels
                    if (el.querySelector('input[type="checkbox"]')) return;
                    
                    // Add tooltip structure if not present
                    if (!el.querySelector('.help-icon')) {
                        el.innerHTML += ` <span class="help-icon">?<div class="tooltip">${translations.helpTexts.guardians}</div></span>`;
                    } else if (el.querySelector('.tooltip')) {
                        el.querySelector('.tooltip').textContent = translations.helpTexts.guardians;
                    }
                });
                
                // Update guardians count help
                const guardiansCountHelp = document.querySelectorAll('.field-label:contains("count")');
                guardiansCountHelp.forEach(el => {
                    // Add tooltip structure if not present
                    if (!el.querySelector('.help-icon') && el.textContent.includes('guardians')) {
                        el.innerHTML += ` <span class="help-icon">?<div class="tooltip">${translations.helpTexts.guardiansCount}</div></span>`;
                    } else if (el.querySelector('.tooltip') && el.textContent.includes('guardians')) {
                        el.querySelector('.tooltip').textContent = translations.helpTexts.guardiansCount;
                    }
                });
                
                // Update guardians type help
                const guardiansTypeHelp = document.querySelectorAll('.field-label:contains("type")');
                guardiansTypeHelp.forEach(el => {
                    // Add tooltip structure if not present
                    if (!el.querySelector('.help-icon') && el.textContent.includes('guardians')) {
                        el.innerHTML += ` <span class="help-icon">?<div class="tooltip">${translations.helpTexts.guardiansType}</div></span>`;
                    } else if (el.querySelector('.tooltip') && el.textContent.includes('guardians')) {
                        el.querySelector('.tooltip').textContent = translations.helpTexts.guardiansType;
                    }
                });
                
                // Update resources help
                const resourcesHelp = document.querySelectorAll('.field-label:contains("resources")');
                resourcesHelp.forEach(el => {
                    // Skip checkbox labels
                    if (el.querySelector('input[type="checkbox"]')) return;
                    
                    // Add tooltip structure if not present
                    if (!el.querySelector('.help-icon')) {
                        el.innerHTML += ` <span class="help-icon">?<div class="tooltip">${translations.helpTexts.resources}</div></span>`;
                    } else if (el.querySelector('.tooltip')) {
                        el.querySelector('.tooltip').textContent = translations.helpTexts.resources;
                    }
                });
                
                // Update chance help
                const chanceHelp = document.querySelectorAll('.field-label:contains("chance")');
                chanceHelp.forEach(el => {
                    // Skip checkbox labels
                    if (el.querySelector('input[type="checkbox"]')) return;
                    
                    // Add tooltip structure if not present
                    if (!el.querySelector('.help-icon')) {
                        el.innerHTML += ` <span class="help-icon">?<div class="tooltip">${translations.helpTexts.chance}</div></span>`;
                    } else if (el.querySelector('.tooltip')) {
                        el.querySelector('.tooltip').textContent = translations.helpTexts.chance;
                    }
                });
                
                // Add custom .contains method for older browsers if needed
                if (!Element.prototype.contains) {
                    Element.prototype.contains = function(text) {
                        return this.textContent.includes(text);
                    };
                }
            }
        }

        // Language selector functionality
        document.getElementById('lang-selector-btn').addEventListener('click', function() {
            document.getElementById('lang-dropdown').classList.toggle('show');
        });

        document.querySelectorAll('#lang-dropdown button').forEach(button => {
            button.addEventListener('click', function() {
                const lang = this.getAttribute('data-lang');
                loadLanguage(lang);
                document.getElementById('lang-dropdown').classList.remove('show');
            });
        });

        // Theme toggle functionality
        document.getElementById('theme-toggle-btn').addEventListener('click', function() {
            isDarkTheme = !isDarkTheme;
            document.body.setAttribute('data-theme', isDarkTheme ? 'dark' : 'light');
            this.textContent = isDarkTheme ? 
                translations.darkTheme : translations.lightTheme;
        });

        // Close dropdown when clicking outside
        window.addEventListener('click', function(event) {
            if (!event.target.matches('#lang-selector-btn')) {
                const dropdown = document.getElementById('lang-dropdown');
                if (dropdown.classList.contains('show')) {
                    dropdown.classList.remove('show');
                }
            }
        });

        // Optional fields toggle
        function setupOptionalField(checkboxId, containerId, callback) {
            const checkbox = document.getElementById(checkboxId);
            const container = document.getElementById(containerId);
            
            if (!checkbox || !container) return;
            
            checkbox.addEventListener('change', function() {
                if (this.checked) {
                    container.classList.remove('disabled');
                } else {
                    container.classList.add('disabled');
                }
                updateJsonPreview();
                if (callback) callback(this.checked);
            });
        }

        // Setup all optional fields
        setupOptionalField('enabled-checkbox', 'enabled-container');
        setupOptionalField('name-checkbox', 'name-container');
        setupOptionalField('sound-checkbox', 'sound-container');
        setupOptionalField('states-checkbox', 'states-container');

        // Initialize state field handlers for the first state
        function setupStateFields(stateIndex) {
            // Set up all optional fields within a state
            setupOptionalField(`state-morale-checkbox-${stateIndex}`, `state-morale-container-${stateIndex}`);
            setupOptionalField(`state-luck-checkbox-${stateIndex}`, `state-luck-container-${stateIndex}`);
            setupOptionalField(`state-spells-checkbox-${stateIndex}`, `state-spells-container-${stateIndex}`);
            setupOptionalField(`state-spellPoints-checkbox-${stateIndex}`, `state-spellPoints-container-${stateIndex}`);
            setupOptionalField(`state-experience-checkbox-${stateIndex}`, `state-experience-container-${stateIndex}`);
            setupOptionalField(`state-skills-checkbox-${stateIndex}`, `state-skills-container-${stateIndex}`);
            setupOptionalField(`state-guardians-checkbox-${stateIndex}`, `state-guardians-container-${stateIndex}`);
            setupOptionalField(`state-resources-checkbox-${stateIndex}`, `state-resources-container-${stateIndex}`);
            setupOptionalField(`state-chance-checkbox-${stateIndex}`, `state-chance-container-${stateIndex}`);
            
            // Set up spell fields for the first spell in this state
            setupOptionalField(`state-spell-id-checkbox-${stateIndex}-0`, `state-spell-id-container-${stateIndex}-0`);
            setupOptionalField(`state-spell-bits-checkbox-${stateIndex}-0`, `state-spell-bits-container-${stateIndex}-0`);
            
            // Fix: Use valid CSS selector syntax - use attribute selectors separately 
            // Add event listeners for all input fields in this state
            document.querySelectorAll(`[id^="state-"][id$="${stateIndex}"]`).forEach(input => {
                if (input.tagName === 'INPUT' && !input.id.includes('checkbox')) {
                    input.addEventListener('input', updateJsonPreview);
                }
            });
            
            // Fix: Use valid CSS selector syntax for spell bits fields
            document.querySelectorAll(`[id^="state-spell-bits-"][id$="${stateIndex}-0"]`).forEach(input => {
                if (input.tagName === 'INPUT') {
                    input.addEventListener('input', updateJsonPreview);
                }
            });
            
            // Setup add/remove spell buttons
            const addSpellBtn = document.querySelector(`.add-spell[data-state-index="${stateIndex}"]`);
            if (addSpellBtn) {
                addSpellBtn.addEventListener('click', function() {
                    addSpellToState(stateIndex);
                });
            }
            
            // Setup remove spell button
            const removeSpellBtn = document.querySelector(`#state-spells-items-${stateIndex} .remove-spell`);
            if (removeSpellBtn) {
                removeSpellBtn.addEventListener('click', function() {
                    resetSpellFields(stateIndex, 0);
                });
            }
            
            // Setup remove state button
            const removeStateBtn = document.querySelectorAll('.remove-state')[stateIndex];
            if (removeStateBtn) {
                removeStateBtn.addEventListener('click', function() {
                    if (document.querySelectorAll('.state-item').length > 1) {
                        this.closest('.state-item').remove();
                        renumberStates();
                        updateJsonPreview();
                        
                        // Enable add button if we're below the max
                        if (document.querySelectorAll('.state-item').length < 4) {
                            document.getElementById('add-state').disabled = false;
                        }
                    } else {
                        // If it's the last state, just reset the fields
                        resetStateFields(0);
                    }
                });
            }
        }
        
        // Function to add a new spell to a state
        function addSpellToState(stateIndex) {
            const spellsContainer = document.getElementById(`state-spells-items-${stateIndex}`);
            const spellsCount = spellsContainer.querySelectorAll('.array-item').length;
            
            if (spellsCount < 4) {
                const newSpellIndex = spellsCount;
                const newSpellHtml = `
                    <div class="array-item">
                        <div class="field-group">
                            <div class="field-row">
                                <div class="field-label">
                                    <input type="checkbox" id="state-spell-id-checkbox-${stateIndex}-${newSpellIndex}">
                                    id
                                </div>
                                <div class="field-input disabled" id="state-spell-id-container-${stateIndex}-${newSpellIndex}">
                                    <input type="number" id="state-spell-id-${stateIndex}-${newSpellIndex}" min="0">
                                </div>
                            </div>
                            
                            <div class="field-row">
                                <div class="field-label">
                                    <input type="checkbox" id="state-spell-bits-checkbox-${stateIndex}-${newSpellIndex}">
                                    bits
                                </div>
                                <div class="field-input disabled" id="state-spell-bits-container-${stateIndex}-${newSpellIndex}">
                                    <div class="field-group">
                                        <div class="field-row">
                                            <div class="field-label">flags</div>
                                            <div class="field-input">
                                                <input type="number" id="state-spell-bits-flags-${stateIndex}-${newSpellIndex}" min="0">
                                            </div>
                                        </div>
                                        <div class="field-row">
                                            <div class="field-label">levels</div>
                                            <div class="field-input">
                                                <input type="number" id="state-spell-bits-levels-${stateIndex}-${newSpellIndex}" min="0">
                                            </div>
                                        </div>
                                        <div class="field-row">
                                            <div class="field-label">schools</div>
                                            <div class="field-input">
                                                <input type="number" id="state-spell-bits-schools-${stateIndex}-${newSpellIndex}" min="0">
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <button class="remove-spell">-</button>
                    </div>
                `;
                
                const tempDiv = document.createElement('div');
                tempDiv.innerHTML = newSpellHtml;
                const newSpellElement = tempDiv.firstElementChild;
                spellsContainer.appendChild(newSpellElement);
                
                // Setup the new spell's fields
                setupOptionalField(`state-spell-id-checkbox-${stateIndex}-${newSpellIndex}`, `state-spell-id-container-${stateIndex}-${newSpellIndex}`);
                setupOptionalField(`state-spell-bits-checkbox-${stateIndex}-${newSpellIndex}`, `state-spell-bits-container-${stateIndex}-${newSpellIndex}`);
                
                // Fix: Update the selector to properly target all input fields in the new spell
                newSpellElement.querySelectorAll('input[type="number"], input[type="text"]').forEach(input => {
                    if (!input.id.includes('checkbox')) {
                        input.addEventListener('input', updateJsonPreview);
                    }
                });
                
                // Add remove spell button listener
                const removeBtn = newSpellElement.querySelector('.remove-spell');
                removeBtn.addEventListener('click', function() {
                    newSpellElement.remove();
                    updateJsonPreview();
                    
                    // Re-enable add button
                    const addBtn = document.querySelector(`.add-spell[data-state-index="${stateIndex}"]`);
                    if (addBtn) {
                        addBtn.disabled = false;
                    }
                });
                
                // Disable add button if we reached the maximum
                if (spellsContainer.querySelectorAll('.array-item').length >= 4) {
                    const addBtn = document.querySelector(`.add-spell[data-state-index="${stateIndex}"]`);
                    if (addBtn) {
                        addBtn.disabled = true;
                    }
                }
                
                updateJsonPreview();
            }
        }
        
        // Function to reset spell fields
        function resetSpellFields(stateIndex, spellIndex) {
            document.getElementById(`state-spell-id-checkbox-${stateIndex}-${spellIndex}`).checked = false;
            document.getElementById(`state-spell-id-container-${stateIndex}-${spellIndex}`).classList.add('disabled');
            document.getElementById(`state-spell-id-${stateIndex}-${spellIndex}`).value = '';
            
            document.getElementById(`state-spell-bits-checkbox-${stateIndex}-${spellIndex}`).checked = false;
            document.getElementById(`state-spell-bits-container-${stateIndex}-${spellIndex}`).classList.add('disabled');
            document.getElementById(`state-spell-bits-flags-${stateIndex}-${spellIndex}`).value = '';
            document.getElementById(`state-spell-bits-levels-${stateIndex}-${spellIndex}`).value = '';
            document.getElementById(`state-spell-bits-schools-${stateIndex}-${spellIndex}`).value = '';
            
            updateJsonPreview();
        }
        
        // Function to reset state fields
        function resetStateFields(stateIndex) {
            // Reset all checkboxes and inputs for the state
            document.querySelectorAll(`[id^=state-][id$=-checkbox-${stateIndex}]`).forEach(checkbox => {
                checkbox.checked = false;
            });
            
            document.querySelectorAll(`[id^=state-][id$=-container-${stateIndex}]`).forEach(container => {
                container.classList.add('disabled');
            });
            
            document.querySelectorAll(`[id^=state-][id$=-${stateIndex}]`).forEach(input => {
                if (input.tagName === 'INPUT' && !input.id.includes('checkbox')) {
                    input.value = '';
                }
            });
            
            // Reset spell fields
            resetSpellFields(stateIndex, 0);
            
            updateJsonPreview();
        }
        
        // Function to renumber states after removal
        function renumberStates() {
            const states = document.querySelectorAll('.state-item');
            states.forEach((state, index) => {
                // Update the heading
                state.querySelector('h4').textContent = `State #${index + 1}`;
                
                // Update all IDs and data attributes
                state.querySelectorAll('[id]').forEach(el => {
                    // Replace old index with new index in IDs
                    const oldId = el.id;
                    // Fix: Use a more reliable way to update IDs
                    if (oldId.includes('state-')) {
                        if (oldId.includes('spell')) {
                            // Handle spell IDs which have two indexes (state and spell)
                            const matches = oldId.match(/^(.*-)\d+(-.*-)\d+$/);
                            if (matches && matches.length === 3) {
                                el.id = matches[1] + index + matches[2] + oldId.match(/\d+$/)[0];
                            }
                        } else {
                            // Handle regular state IDs with one index
                            const matches = oldId.match(/^(.*-)\d+$/);
                            if (matches && matches.length === 2) {
                                el.id = matches[1] + index;
                            }
                        }
                    }
                });
                
                // Update data-state-index attributes
                state.querySelectorAll('[data-state-index]').forEach(el => {
                    el.setAttribute('data-state-index', index);
                });
                
                // Update related event listeners
                setupStateFields(index);
            });
        }
        
        // Setup for adding new states
        document.getElementById('add-state').addEventListener('click', function() {
            const statesContainer = document.getElementById('states-items');
            const statesCount = statesContainer.querySelectorAll('.state-item').length;
            
            if (statesCount < 4) {
                const newStateIndex = statesCount;
                const stateTemplate = document.querySelector('.state-item').cloneNode(true);
                
                // Update ID attributes and heading
                stateTemplate.querySelector('h4').textContent = `State #${newStateIndex + 1}`;
                
                // Update all IDs within the template
                stateTemplate.querySelectorAll('[id]').forEach(el => {
                    const oldId = el.id;
                    const parts = oldId.split('-');
                    const indexPosition = oldId.includes('spell') ? oldId.lastIndexOf('-') - 2 : oldId.lastIndexOf('-');
                    const newId = oldId.substring(0, indexPosition) + '-' + newStateIndex + oldId.substring(oldId.lastIndexOf('-'));
                    el.id = newId;
                });
                
                // Update data-state-index attributes
                stateTemplate.querySelectorAll('[data-state-index]').forEach(el => {
                    el.setAttribute('data-state-index', newStateIndex);
                });
                
                // Reset all checkboxes and inputs
                stateTemplate.querySelectorAll('input[type="checkbox"]').forEach(checkbox => {
                    checkbox.checked = false;
                });
                
                stateTemplate.querySelectorAll('.field-input').forEach(container => {
                    if (!container.id.includes('state-spells-items')) {
                        container.classList.add('disabled');
                    }
                });
                
                stateTemplate.querySelectorAll('input[type="number"], input[type="text"]').forEach(input => {
                    input.value = '';
                });
                
                // Handle spell items container
                const spellItemsContainer = stateTemplate.querySelector(`[id^=state-spells-items-]`);
                if (spellItemsContainer) {
                    spellItemsContainer.id = `state-spells-items-${newStateIndex}`;
                    // Keep only one spell item template
                    const firstSpellItem = spellItemsContainer.querySelector('.array-item');
                    while (spellItemsContainer.children.length > 1) {
                        spellItemsContainer.removeChild(spellItemsContainer.lastChild);
                    }
                }
                
                statesContainer.appendChild(stateTemplate);
                
                // Setup the new state's fields
                setupStateFields(newStateIndex);
                
                // Disable add button if we reached the maximum
                if (statesContainer.querySelectorAll('.state-item').length >= 4) {
                    this.disabled = true;
                }
                
                updateJsonPreview();
            }
        });
        
        // Initialize the first state
        setupStateFields(0);

        // Array field functionality - remove older functions that aren't needed anymore
        // setupArrayField('add-state', 'states-items', 'state-item');
        // setupArrayField('add-spell', 'spells-items', 'spell-item');

        // JSON preview toggle
        document.getElementById('toggle-json').addEventListener('click', function() {
            const jsonPreview = document.getElementById('json-preview');
            jsonPreview.classList.toggle('show');
            this.textContent = jsonPreview.classList.contains('show') ? 
                translations.hideJsonCode : translations.showJsonCode;
            updateJsonPreview();
        });

        // Required fields validation and Save button enable/disable
        function validateRequiredFields() {
            const subtype = document.getElementById('object-subtype').value;
            const value = document.getElementById('value').value;
            const density = document.getElementById('density').value;
            const properties = document.getElementById('properties').value;
            
            return subtype !== '' && value !== '' && density !== '' && properties !== '';
        }

        function updateSaveButtonState() {
            document.getElementById('save-file').disabled = !validateRequiredFields();
        }

        document.getElementById('value').addEventListener('input', function() {
            updateSaveButtonState();
            updateJsonPreview();
        });
        
        document.getElementById('density').addEventListener('input', function() {
            updateSaveButtonState();
            updateJsonPreview();
        });
        
        document.getElementById('properties').addEventListener('input', function() {
            updateSaveButtonState();
            updateJsonPreview();
        });

        // Sound field validation (.wav extension)
        function validateWavFile(input) {
            if (input.value && !input.value.toLowerCase().endsWith('.wav')) {
                input.value = input.value + '.wav';
            }
            updateJsonPreview();
        }

        document.getElementById('sound-enter').addEventListener('blur', function() {
            validateWavFile(this);
        });
        
        document.getElementById('sound-loop').addEventListener('blur', function() {
            validateWavFile(this);
        });

        document.getElementById('sound-enter').addEventListener('input', updateJsonPreview);
        document.getElementById('sound-loop').addEventListener('input', updateJsonPreview);
        document.getElementById('name').addEventListener('input', updateJsonPreview);
        document.getElementById('enabled').addEventListener('change', updateJsonPreview);
        document.getElementById('object-subtype').addEventListener('input', function() {
            updateSaveButtonState();
            updateJsonPreview();
        });

        // Generate JSON preview - updated to handle the complex states structure
        function updateJsonPreview() {
            const jsonObj = buildJsonObject();
            const jsonString = JSON.stringify(jsonObj, null, 2);
            document.getElementById('json-preview').textContent = jsonString;
            updateSaveButtonState(); // Update save button state when JSON is updated
        }

        function buildJsonObject() {
            const innerJsonObj = {};
            
            // Required fields
            innerJsonObj.value = parseInt(document.getElementById('value').value) || 0;
            innerJsonObj.density = parseInt(document.getElementById('density').value) || 0;
            innerJsonObj.properties = [document.getElementById('properties').value];
            
            // Optional fields
            if (document.getElementById('enabled-checkbox').checked) {
                innerJsonObj.enabled = document.getElementById('enabled').value === 'true';
            }
            
            if (document.getElementById('name-checkbox').checked) {
                innerJsonObj.name = document.getElementById('name').value;
            }
            
            if (document.getElementById('sound-checkbox').checked) {
                const enter = document.getElementById('sound-enter').value;
                const loop = document.getElementById('sound-loop').value;
                
                if (enter || loop) {
                    innerJsonObj.sound = {};
                    if (enter) innerJsonObj.sound.enter = enter;
                    if (loop) innerJsonObj.sound.loop = loop;
                }
            }
            
            // Handle states array
            if (document.getElementById('states-checkbox').checked) {
                const stateElements = document.querySelectorAll('.state-item');
                if (stateElements.length > 0) {
                    innerJsonObj.states = [];
                    
                    stateElements.forEach((stateElement, stateIndex) => {
                        const stateObj = {};
                        
                        // Process all optional fields in the state
                        if (document.getElementById(`state-morale-checkbox-${stateIndex}`).checked) {
                            stateObj.morale = parseInt(document.getElementById(`state-morale-${stateIndex}`).value) || 0;
                        }
                        
                        if (document.getElementById(`state-luck-checkbox-${stateIndex}`).checked) {
                            stateObj.luck = parseInt(document.getElementById(`state-luck-${stateIndex}`).value) || 0;
                        }
                        
                        // Handle spells array within state
                        if (document.getElementById(`state-spells-checkbox-${stateIndex}`).checked) {
                            const spellElements = document.querySelectorAll(`#state-spells-items-${stateIndex} .array-item`);
                            if (spellElements.length > 0) {
                                stateObj.spells = [];
                                
                                spellElements.forEach((spellElement, spellIndex) => {
                                    const spellObj = {};
                                    
                                    // Add id if checked
                                    if (document.getElementById(`state-spell-id-checkbox-${stateIndex}-${spellIndex}`)) {
                                        const idCheckbox = document.getElementById(`state-spell-id-checkbox-${stateIndex}-${spellIndex}`);
                                        if (idCheckbox && idCheckbox.checked) {
                                            const idInput = document.getElementById(`state-spell-id-${stateIndex}-${spellIndex}`);
                                            if (idInput) {
                                                spellObj.id = parseInt(idInput.value) || 0;
                                            }
                                        }
                                    }
                                    
                                    // Add bits if checked
                                    if (document.getElementById(`state-spell-bits-checkbox-${stateIndex}-${spellIndex}`)) {
                                        const bitsCheckbox = document.getElementById(`state-spell-bits-checkbox-${stateIndex}-${spellIndex}`);
                                        if (bitsCheckbox && bitsCheckbox.checked) {
                                            spellObj.bits = {};
                                            
                                            const flagsInput = document.getElementById(`state-spell-bits-flags-${stateIndex}-${spellIndex}`);
                                            const levelsInput = document.getElementById(`state-spell-bits-levels-${stateIndex}-${spellIndex}`);
                                            const schoolsInput = document.getElementById(`state-spell-bits-schools-${stateIndex}-${spellIndex}`);
                                            
                                            if (flagsInput && flagsInput.value) spellObj.bits.flags = parseInt(flagsInput.value);
                                            if (levelsInput && levelsInput.value) spellObj.bits.levels = parseInt(levelsInput.value);
                                            if (schoolsInput && schoolsInput.value) spellObj.bits.schools = parseInt(schoolsInput.value);
                                            
                                            // Remove empty bits object
                                            if (Object.keys(spellObj.bits).length === 0) {
                                                delete spellObj.bits;
                                            }
                                        }
                                    }
                                    
                                    // Only add non-empty spell objects
                                    if (Object.keys(spellObj).length > 0) {
                                        stateObj.spells.push(spellObj);
                                    }
                                });
                                
                                // Remove spells array if empty
                                if (stateObj.spells.length === 0) {
                                    delete stateObj.spells;
                                }
                            }
                        }
                        
                        if (document.getElementById(`state-spellPoints-checkbox-${stateIndex}`)) {
                            const spellPointsCheckbox = document.getElementById(`state-spellPoints-checkbox-${stateIndex}`);
                            if (spellPointsCheckbox && spellPointsCheckbox.checked) {
                                const spellPointsInput = document.getElementById(`state-spellPoints-${stateIndex}`);
                                if (spellPointsInput) {
                                    stateObj.spellPoints = parseInt(spellPointsInput.value) || 0;
                                }
                            }
                        }
                        
                        if (document.getElementById(`state-experience-checkbox-${stateIndex}`)) {
                            const experienceCheckbox = document.getElementById(`state-experience-checkbox-${stateIndex}`);
                            if (experienceCheckbox && experienceCheckbox.checked) {
                                const experienceInput = document.getElementById(`state-experience-${stateIndex}`);
                                if (experienceInput) {
                                    stateObj.experience = parseInt(experienceInput.value) || 0;
                                }
                            }
                        }
                        
                        if (document.getElementById(`state-skills-checkbox-${stateIndex}`)) {
                            const skillsCheckbox = document.getElementById(`state-skills-checkbox-${stateIndex}`);
                            if (skillsCheckbox && skillsCheckbox.checked) {
                                const primarySkillsInput = document.getElementById(`state-skills-primary-${stateIndex}`);
                                if (primarySkillsInput && primarySkillsInput.value) {
                                    stateObj.skills = {
                                        primary: primarySkillsInput.value.split(',').map(val => parseInt(val.trim()) || 0)
                                    };
                                }
                            }
                        }
                        
                        if (document.getElementById(`state-guardians-checkbox-${stateIndex}`)) {
                            const guardiansCheckbox = document.getElementById(`state-guardians-checkbox-${stateIndex}`);
                            if (guardiansCheckbox && guardiansCheckbox.checked) {
                                const countInput = document.getElementById(`state-guardians-count-${stateIndex}`);
                                const typeInput = document.getElementById(`state-guardians-type-${stateIndex}`);
                                
                                if ((countInput && countInput.value) || (typeInput && typeInput.value)) {
                                    stateObj.guardians = {};
                                    if (countInput && countInput.value) {
                                        stateObj.guardians.count = countInput.value.split(',').map(val => parseInt(val.trim()) || 0);
                                    }
                                    if (typeInput && typeInput.value) {
                                        stateObj.guardians.type = typeInput.value.split(',').map(val => parseInt(val.trim()));
                                    }
                                }
                            }
                        }
                        
                        if (document.getElementById(`state-resources-checkbox-${stateIndex}`)) {
                            const resourcesCheckbox = document.getElementById(`state-resources-checkbox-${stateIndex}`);
                            if (resourcesCheckbox && resourcesCheckbox.checked) {
                                const resourcesInput = document.getElementById(`state-resources-${stateIndex}`);
                                if (resourcesInput && resourcesInput.value) {
                                    stateObj.resources = resourcesInput.value.split(',').map(val => parseInt(val.trim()) || 0);
                                }
                            }
                        }
                        
                        if (document.getElementById(`state-chance-checkbox-${stateIndex}`)) {
                            const chanceCheckbox = document.getElementById(`state-chance-checkbox-${stateIndex}`);
                            if (chanceCheckbox && chanceCheckbox.checked) {
                                const chanceInput = document.getElementById(`state-chance-${stateIndex}`);
                                if (chanceInput) {
                                    stateObj.chance = parseInt(chanceInput.value) || 0;
                                }
                            }
                        }
                        
                        // Only add non-empty state objects
                        if (Object.keys(stateObj).length > 0) {
                            innerJsonObj.states.push(stateObj);
                        }
                    });
                    
                    // Remove states array if empty
                    if (innerJsonObj.states.length === 0) {
                        delete innerJsonObj.states;
                    }
                }
            }
            
            // Wrap in the required structure
            const subtype = document.getElementById('object-subtype').value || "13";
            
            return {
                "RMG": {
                    "objectGeneration": {
                        "16": {
                            [subtype]: innerJsonObj
                        }
                    }
                }
            };
        }

        // Save file functionality
        document.getElementById('save-file').addEventListener('click', function() {
            if (!validateRequiredFields()) return;
            
            const jsonObj = buildJsonObject();
            const jsonString = JSON.stringify(jsonObj, null, 2);
            const blob = new Blob([jsonString], { type: 'application/json' });
            
            const a = document.createElement('a');
            a.href = URL.createObjectURL(blob);
            a.download = 'creature_bank.json';
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(a.href); // Clean up the created URL
        });

        // PWA installation
        let deferredPrompt;

        window.addEventListener('beforeinstallprompt', (e) => {
            e.preventDefault();
            deferredPrompt = e;
            
            // Show the install button
            const installButton = document.getElementById('install-pwa');
            installButton.style.display = 'block';
            
            installButton.addEventListener('click', async () => {
                if (!deferredPrompt) return;
                
                deferredPrompt.prompt();
                const { outcome } = await deferredPrompt.userChoice;
                
                if (outcome === 'accepted') {
                    console.log('User accepted the install prompt');
                } else {
                    console.log('User dismissed the install prompt');
                }
                
                deferredPrompt = null;
                installButton.style.display = 'none';
            });
        });

        // Generate manifest dynamically
        const manifestData = {
            name: "Creature Bank Editor for Heroes 3: ERA",
            short_name: "Creature Bank Editor",
            description: "JSON editor for Heroes 3: ERA creature banks",
            start_url: "./",
            display: "standalone",
            background_color: "#1f2937",
            theme_color: "#1f2937",
            icons: [
                {
                    src: "./icon-192.png",
                    sizes: "192x192",
                    type: "image/png"
                },
                {
                    src: "./icon-512.png", 
                    sizes: "512x512",
                    type: "image/png"
                }
            ]
        };

        const manifestString = JSON.stringify(manifestData);
        const manifestBlob = new Blob([manifestString], {type: 'application/json'});
        const manifestURL = URL.createObjectURL(manifestBlob);
        document.getElementById('manifestPlaceholder').href = manifestURL;

        // Register service worker
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                // In a real app, you would register a real service worker file
                // For this demo, we'll just log to console
                console.log('Service Worker would be registered here in a real PWA');
            });
        }
        
        // Initialize UI - load default language first
        document.addEventListener('DOMContentLoaded', () => {
            loadLanguage(currentLang);
            document.body.setAttribute('data-theme', isDarkTheme ? 'dark' : 'light');
        });

        // Update initial UI state (fallback if language load fails)
        updateJsonPreview();
    </script>
</body>
</html>
